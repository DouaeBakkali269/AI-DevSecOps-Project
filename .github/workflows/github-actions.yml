name: DevSecOps Security Policy Generator

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  security-scan-and-policy-generation:
    runs-on: ubuntu-latest
    
    # Add Juice Shop as a service container
    services:
      juice-shop:
        image: bkimminich/juice-shop
        ports:
          - 3000:3000
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Create Results Directories
      run: |
        mkdir -p results/scan_reports
        mkdir -p results/parsed_data
        mkdir -p results/generated_policies
        mkdir -p results/evaluations
    
    - name: Clone OWASP Juice Shop (for CodeQL analysis)
      run: |
        mkdir -p app
        git clone --depth 1 https://github.com/juice-shop/juice-shop.git app/juice-shop
    
    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        cd app/juice-shop && npm install
    
    # ==================== SAST Scanning - CodeQL ====================
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-and-quality
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"
        output: results/scan_reports
        upload: false
    
    - name: Export CodeQL Results to SARIF
      run: |
        # Find and copy CodeQL SARIF results
        find . -name "*.sarif" -type f -exec cp {} results/scan_reports/codeql_report.sarif \; || true
        
        # Verify the file exists
        if [ -f results/scan_reports/codeql_report.sarif ]; then
          echo "✅ CodeQL SARIF report created"
          ls -lh results/scan_reports/codeql_report.sarif
        else
          echo "⚠️ CodeQL SARIF report not found, creating empty report"
          echo '{"version":"2.1.0","runs":[]}' > results/scan_reports/codeql_report.sarif
        fi
    
    # ==================== SCA Scanning - Snyk ====================
    
    - name: Run Snyk Security Scan (SCA)
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        command: test
        args: --all-projects --json-file-output=results/scan_reports/snyk_report.json
        json: true
    
    - name: Verify Snyk Results
      run: |
        if [ -f results/scan_reports/snyk_report.json ]; then
          echo "✅ Snyk scan completed successfully"
          # Show summary
          python3 -c "import json; data=json.load(open('results/scan_reports/snyk_report.json')); print(f'Vulnerabilities found: {len(data.get(\"vulnerabilities\", []))}')" || true
        else
          echo "⚠️ Snyk report not found, creating empty report"
          echo '{"vulnerabilities":[]}' > results/scan_reports/snyk_report.json
        fi
    
    # ==================== DAST Scanning ====================
    
    - name: Wait for Juice Shop to be ready
      run: |
        echo "Waiting for Juice Shop service to be ready..."
        for i in {1..30}; do
          if curl -sSf http://localhost:3000 > /dev/null 2>&1; then
            echo "✅ Juice Shop is ready!"
            break
          fi
          echo "Waiting... attempt $i/30"
          sleep 5
        done
        # Verify one more time
        curl -sSf http://localhost:3000 || (echo "❌ Juice Shop failed to start" && exit 1)
    
    - name: Run OWASP ZAP Baseline Scan (DAST)
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:3000'
        cmd_options: '-a'
        fail_action: false
        token: ''
        allow_issue_writing: false
      continue-on-error: true
    
    - name: Move ZAP Reports to Results Directory
      run: |
        echo "Looking for ZAP reports..."
        ls -la
        
        # ZAP action creates reports with specific names in the root directory
        if [ -f "report_html.html" ]; then
          mv report_html.html results/scan_reports/zap_report.html
          echo "✅ Moved HTML report"
        else
          echo "⚠️ HTML report not found"
        fi
        
        if [ -f "report_json.json" ]; then
          mv report_json.json results/scan_reports/zap_report.json
          echo "✅ Moved JSON report"
        else
          echo "⚠️ JSON report not found, creating empty report"
          echo '{"site":[]}' > results/scan_reports/zap_report.json
        fi
        
        if [ -f "report_md.md" ]; then
          mv report_md.md results/scan_reports/zap_report.md
          echo "✅ Moved Markdown report"
        fi
        
        # List what we have in results
        echo "Contents of results/scan_reports:"
        ls -lh results/scan_reports/
    
    # ==================== Parse Reports ====================
    
    - name: Parse Vulnerability Reports
      run: |
        python parsers/parse_reports.py \
          --input results/scan_reports \
          --output results/parsed_data/vulnerabilities.json
      continue-on-error: true
    
    - name: Verify Parsed Data
      run: |
        if [ -f results/parsed_data/vulnerabilities.json ]; then
          echo "✅ Vulnerabilities parsed successfully"
          cat results/parsed_data/vulnerabilities.json | head -20
        else
          echo "⚠️ Creating empty vulnerabilities file"
          echo '{"vulnerabilities":[]}' > results/parsed_data/vulnerabilities.json
        fi
    
    # ==================== Generate Policies with LLMs ====================
    
    - name: Generate Security Policies (GPT-4)
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python llm-policy-generator/policy_generator.py \
          --model gpt-4 \
          --input results/parsed_data/vulnerabilities.json \
          --output results/generated_policies/gpt4_policies.json
      continue-on-error: true
    
    - name: Generate Security Policies (Claude)
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python llm-policy-generator/policy_generator.py \
          --model claude-sonnet-4.5 \
          --input results/parsed_data/vulnerabilities.json \
          --output results/generated_policies/claude_policies.json
      continue-on-error: true
    
    - name: Generate Security Policies (DeepSeek)
      env:
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
      run: |
        python llm-policy-generator/policy_generator.py \
          --model deepseek-r1 \
          --input results/parsed_data/vulnerabilities.json \
          --output results/generated_policies/deepseek_policies.json
      continue-on-error: true
    
    # ==================== Evaluate Policies ====================
    
    - name: Evaluate Generated Policies
      run: |
        python evaluation/evaluate_policies.py \
          --generated results/generated_policies \
          --reference reference-policies \
          --output results/evaluations/metrics.json
      continue-on-error: true
    
    # ==================== Generate Report ====================
    
    - name: Generate Comparison Report
      run: |
        python evaluation/generate_report.py \
          --metrics results/evaluations/metrics.json \
          --output results/final_report.html
      continue-on-error: true
    
    # ==================== Upload Artifacts ====================
    
    - name: Upload Scan Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-reports
        path: results/scan_reports/
        if-no-files-found: warn
    
    - name: Upload Generated Policies
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generated-policies
        path: results/generated_policies/
        if-no-files-found: warn
    
    - name: Upload Evaluation Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: evaluation-results
        path: results/evaluations/
        if-no-files-found: warn
    
    - name: Upload Final Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: final-report
        path: results/final_report.html
        if-no-files-found: warn
    
    # ==================== Security Gates ====================
    
    - name: Check Critical Vulnerabilities
      run: |
        python pipeline/check_security_gates.py \
          --report results/parsed_data/vulnerabilities.json \
          --threshold critical
      continue-on-error: true
    
    - name: Pipeline Summary
      if: always()
      run: |
        echo "==================== Pipeline Summary ===================="
        echo "Scan Reports Generated:"
        ls -lh results/scan_reports/ 2>/dev/null || echo "No scan reports"
        echo ""
        echo "Policies Generated:"
        ls -lh results/generated_policies/ 2>/dev/null || echo "No policies generated"
        echo ""
        echo "Evaluations:"
        ls -lh results/evaluations/ 2>/dev/null || echo "No evaluations"
        echo "========================================================"